# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **LinuxServer.io WireGuard Docker container** — a production-ready, multi-architecture Docker image that runs WireGuard VPN in either server or client mode. The container is built on Alpine Linux 3.23 and managed via s6-overlay.

## Building Locally

```bash
# x86-64
docker build \
  --no-cache \
  --pull \
  -t lsiodev/wireguard:latest .

# ARM64 (aarch64)
docker build \
  --no-cache \
  --pull \
  -f Dockerfile.aarch64 \
  -t lsiodev/wireguard:latest .

# RISC-V 64 (riscv64) — uses debian:bookworm-slim, not Alpine
docker build \
  --no-cache \
  --pull \
  -f Dockerfile.riscv64 \
  -t lsiodev/wireguard:riscv64-latest .

# Cross-compile from x86 with QEMU:
docker buildx build \
  --platform linux/riscv64 \
  -f Dockerfile.riscv64 \
  -t lsiodev/wireguard:riscv64-latest .
```

## RISC-V 64 Notes

`Dockerfile.riscv64` targets RISC-V 64-bit hardware (e.g., SBCs running Ubuntu 24.04 LTS).

Key differences from the Alpine-based images:
- **Base image**: `debian:trixie-slim` (Debian 13; `bookworm`/Debian 12 has no riscv64 manifest — trixie is the earliest Debian release with riscv64 support)
- **Init system**: No s6-overlay. A simplified shell entrypoint (`root/entrypoint-riscv64.sh`) calls the existing s6 scripts directly as bash scripts
- **CoreDNS**: Not available on riscv64. `USE_COREDNS` is hardcoded to `false` in the entrypoint; use `PEERDNS` to point peers at an external DNS server
- **`lsiown`**: This linuxserver-specific helper does not exist in the Debian image. The entrypoint stubs it as a `chown` shell function before sourcing the s6 scripts

The `Dockerfile.riscv64` is **not** auto-generated by the CI/CD pipeline and can be edited directly.

## Auto-Generated Files

Several files are **auto-generated by the CI/CD pipeline** and should not be edited directly. Edit the source templates instead:

| Auto-generated | Source template |
|---|---|
| `Dockerfile` | Jenkins template |
| `Dockerfile.aarch64` | Jenkins template |
| `Jenkinsfile` | Jenkins template |
| `README.md` | `readme-vars.yml` |
| `package_versions.txt` | CI pipeline |

To change project metadata, environment variable documentation, or changelog entries, edit **`readme-vars.yml`**.

To change CI/CD pipeline behavior, edit **`jenkins-vars.yml`**.

## Architecture

### Dual-Mode Operation

The container operates in two modes, determined by the presence of config files:

- **Server mode**: Activated when `/config/wg_confs/` has no existing configs. Generates server and peer configuration files, assigns IPs, creates keys, and produces QR codes.
- **Client mode**: Uses existing `.conf` files in `/config/wg_confs/`. CoreDNS is disabled in this mode.

### s6-overlay Services (`root/etc/s6-overlay/s6-rc.d/`)

Initialization and service scripts run in this order:

1. **`init-wireguard-module`** — Verifies the WireGuard kernel module is available (requires `SYS_MODULE` capability or pre-loaded module).
2. **`init-wireguard-confs`** — Main initialization: generates server/peer configs, keys, and QR codes in server mode; skips generation in client mode. State is persisted in `/config/.donoteditthisfile`.
3. **`svc-wireguard`** — Activates all `.conf` files in `/config/wg_confs/` via `wg-quick` in alphabetical order. If any tunnel fails, all are torn down (atomic failure).
4. **`svc-coredns`** — Starts CoreDNS for DNS resolution (server mode only, and only when port 53 is available).

### Configuration Templates (`root/defaults/`)

- `server.conf` — WireGuard interface template with iptables PostUp/PostDown rules
- `peer.conf` — Per-peer client config template with preshared key support
- `Corefile` — CoreDNS config forwarding to the host's resolv.conf

Templates are copied to `/config/templates/` on first run and can be customized there.

### Key Environment Variables

| Variable | Default | Description |
|---|---|---|
| `PEERS` | — | Number of peers or comma-separated named peers (activates server mode) |
| `SERVERURL` | `auto` | External hostname/IP; `auto` detects via ifconfig.co |
| `SERVERPORT` | `51820` | UDP port for WireGuard |
| `INTERNAL_SUBNET` | `10.13.13.0` | VPN subnet |
| `PEERDNS` | `auto` | DNS for peer configs; `auto` uses CoreDNS server IP |
| `ALLOWEDIPS` | `0.0.0.0/0` | AllowedIPs in peer configs (split tunneling control) |
| `SERVER_ALLOWEDIPS_PEER_*` | — | Per-peer AllowedIPs for site-to-site VPN |
| `USE_COREDNS` | `true` | Set to `false` to disable CoreDNS |

### Persistent Data

All configuration lives in `/config/` (mounted as a volume):
- `/config/wg_confs/` — WireGuard `.conf` files (symlinked from `/etc/wireguard`)
- `/config/server/` — Server keys
- `/config/peer_*/` — Per-peer keys and configs
- `/config/coredns/` — CoreDNS runtime config
- `/config/templates/` — Editable config templates
- `/config/.donoteditthisfile` — State file tracking peer count and server keys

### Utilities

- **`root/app/show-peer`** — Display QR code for a peer: `docker exec wireguard /app/show-peer <peer_name_or_number>`
